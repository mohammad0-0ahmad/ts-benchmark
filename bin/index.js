#!/usr/bin/env node
"use strict";var e=require("child_process"),t=require("chalk"),r=require("chokidar"),n=require("console-table-printer"),a=require("@actions/core"),i=require("fs"),o=require("path"),c=require("yargs");function s(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var l=s(t),u=s(a),d=s(c),h=function(){return h=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var a in t=arguments[r])Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a]);return e},h.apply(this,arguments)};function f(e,t){var r={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var a=0;for(n=Object.getOwnPropertySymbols(e);a<n.length;a++)t.indexOf(n[a])<0&&Object.prototype.propertyIsEnumerable.call(e,n[a])&&(r[n[a]]=e[n[a]])}return r}function p(e,t,r,n){return new(r||(r=Promise))((function(a,i){function o(e){try{s(n.next(e))}catch(e){i(e)}}function c(e){try{s(n.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,c)}s((n=n.apply(e,t||[])).next())}))}function v(e,t){var r,n,a,i,o={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return i={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function c(i){return function(c){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;o;)try{if(r=1,n&&(a=2&i[0]?n.return:i[0]?n.throw||((a=n.return)&&a.call(n),0):n.next)&&!(a=a.call(n,i[1])).done)return a;switch(n=0,a&&(i=[2&i[0],a.value]),i[0]){case 0:case 1:a=i;break;case 4:return o.label++,{value:i[1],done:!1};case 5:o.label++,n=i[1],i=[0];continue;case 7:i=o.ops.pop(),o.trys.pop();continue;default:if(!(a=o.trys,(a=a.length>0&&a[a.length-1])||6!==i[0]&&2!==i[0])){o=0;continue}if(3===i[0]&&(!a||i[1]>a[0]&&i[1]<a[3])){o.label=i[1];break}if(6===i[0]&&o.label<a[1]){o.label=a[1],a=i;break}if(a&&o.label<a[2]){o.label=a[2],o.ops.push(i);break}a[2]&&o.ops.pop(),o.trys.pop();continue}i=t.call(e,o)}catch(e){i=[6,e],n=0}finally{r=a=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,c])}}}function b(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,a,i=r.call(e),o=[];try{for(;(void 0===t||t-- >0)&&!(n=i.next()).done;)o.push(n.value)}catch(e){a={error:e}}finally{try{n&&!n.done&&(r=i.return)&&r.call(i)}finally{if(a)throw a.error}}return o}function m(e,t,r){if(r||2===arguments.length)for(var n,a=0,i=t.length;a<i;a++)!n&&a in t||(n||(n=Array.prototype.slice.call(t,0,a)),n[a]=t[a]);return e.concat(n||Array.prototype.slice.call(t))}var g={},y=["Files","Lines of Library","Lines of Definitions","Lines of TypeScript","Lines of JavaScript","Lines of JSON","Lines of Other","Nodes of Library","Nodes of Definitions","Nodes of TypeScript","Nodes of JavaScript","Nodes of JSON","Nodes of Other","Identifiers","Symbols","Types","Instantiations","Memory used","Assignability cache size","Identity cache size","Subtype cache size","Strict subtype cache size","I/O Read time","Parse time","ResolveModule time","ResolveTypeReference time","Program time","Bind time","Check time","printTime time","Emit time","Total time"],w={field:"white",branch:"lightgreen",initial:"blue",previous:"yellow",current:"cyan"},k={lightgreen:"[1m[32m"},O="✓",N="⛌",S="✔️",B="❌",j={style:{headerTop:{left:" ",mid:" ",right:" ",other:"⠀"},headerBottom:{left:" ",mid:" ",right:" ",other:"⠀"},tableBottom:{left:"⠀",mid:"⠀",right:"⠀",other:"⠀"},vertical:" "}},T=function(t){return new Promise((function(r){e.exec(t,(function(e,t,n){r({error:e,stdout:t,stderr:n})}))}))},x=function(e){var t=e.$0,r=e.path;return p(void 0,void 0,void 0,(function(){var e,n,a,i;return v(this,(function(o){switch(o.label){case 0:if(!r)return[2];o.label=1;case 1:return o.trys.push([1,3,,4]),[4,T("tsc -p ".concat(r," --extendeddiagnostics -noEmit"))];case 2:return e=o.sent(),n=e.error,a=e.stdout,i=a.indexOf("Files:"),n&&console.error("".concat(t,":\n"),a.substring(0,i)),-1===i?(console.log(a),[2]):[2,a.substring(i)];case 3:return o.sent(),[2];case 4:return[2]}}))}))},F=function(e,t){var r,n=e.visibleFields;if(t){var a=t.split("\n");return null===(r=Object.entries(n))||void 0===r?void 0:r.reduce((function(e,t){var r,n,i,o=b(t,2),c=o[0],s=o[1].label,l=parseInt(c);if(null===(n=a[l])||void 0===n?void 0:n.startsWith(s)){var u=null===(i=a[l].match(/\d.*/))||void 0===i?void 0:i[0];return u?h(h({},e),((r={})[s]=u,r)):e}return e}),{})}},A=function(e){return p(void 0,void 0,void 0,(function(){var t,r,n,a,i,o,c,s,l,u,d,h,f,p;return v(this,(function(v){switch(v.label){case 0:return t=e.$0,r=e.path,n=e.branch,a=e.initial,i=e.github,o=e.target,console.log("".concat(t,": Preparing...")),console.log("".concat(t,": Please do not make any changes in your workspace until preparing process is done.")),r?(c=g,[4,T(i?"git rev-parse --short HEAD":"git branch --show-current")]):[2];case 1:return c.currentBranchName=v.sent().stdout.trim(),a?(s=g,l=F,u=[e],[4,x(e)]):[3,3];case 2:s.initial=l.apply(void 0,u.concat([v.sent()]))||{},v.label=3;case 3:return g.branchName=n?n.trim():void 0,g.branchName&&g.branchName!==g.currentBranchName?(d=g,[4,E(e,g.branchName)]):[3,5];case 4:d.branch=v.sent(),v.label=5;case 5:return i&&o&&(null===(f=process.env)||void 0===f?void 0:f.GITHUB_BASE_REF)&&(null===(p=process.env)||void 0===p?void 0:p.GITHUB_BASE_REF)!==g.branchName?(g.targetName=process.env.GITHUB_BASE_REF,h=g,[4,E(e,g.targetName)]):[3,7];case 6:h.target=v.sent(),v.label=7;case 7:return console.log("".concat(t,": Preparing process done :)")),[2]}}))}))},E=function(e,t){return p(void 0,void 0,void 0,(function(){var r,n,a,i,o,c,s,l,u,d,h,f;return v(this,(function(p){switch(p.label){case 0:return r=e.$0,(n=e.github)?[4,T('git config --global user.email "test@ts-benchmark.com"')]:[3,3];case 1:return p.sent(),[4,T('git config --global user.name "ts-benchmark"')];case 2:p.sent(),p.label=3;case 3:return[4,T("git add .")];case 4:return p.sent(),n?(i=!1,[3,9]):[3,5];case 5:return c=Boolean,[4,T("git diff --name-only --cached")];case 6:return(o=c.apply(void 0,[p.sent()||!1]))?(s=Boolean,[4,T("git branch --list ".concat(g.branchName))]):[3,8];case 7:o=s.apply(void 0,[p.sent()||!1]),p.label=8;case 8:i=o,p.label=9;case 9:return(a=i)?[4,T("git commit -m ".concat(r,"-temp-commit"))]:[3,11];case 10:p.sent(),p.label=11;case 11:return[4,T("git checkout ".concat(t))];case 12:return p.sent(),u=F,d=[e],[4,x(e)];case 13:return l=u.apply(void 0,d.concat([p.sent()]))||{},[4,T("git checkout ".concat(g.currentBranchName))];case 14:return p.sent(),(f=a)?[4,T("git log -1 --pretty=%B")]:[3,16];case 15:f=p.sent().stdout.trim(),p.label=16;case 16:return h=f,a&&h==="".concat(r,"-temp-commit")?[4,T("git reset HEAD~")]:[3,18];case 17:p.sent(),p.label=18;case 18:return[2,l]}}))}))},I=function(e){return p(void 0,void 0,void 0,(function(){var t,r,a,c,s,d,p,y,T,A;return v(this,(function(v){switch(v.label){case 0:return t=e.save,r=e.$0,c=F,s=[e],[4,x(e)];case 1:if(a=c.apply(void 0,s.concat([v.sent()])),d=function(e,t,r){var n=e.visibleFields;void 0===r&&(r=!0);var a=Object.keys(t);if(t&&(null==a?void 0:a.length)){var i=(null==g?void 0:g.tableColumns)||m(["field"],b(a),!1).map((function(e){var t="branch"===e||"target"===e?g["".concat(e,"Name")]:e;return{name:e,alignment:"left",color:null==w?void 0:w[e],title:t.charAt(0).toUpperCase()+t.slice(1)}})),o=!1,c=Object.entries(n).reduce((function(e,n){var i=b(n,2);i[0];var c=i[1],s=c.label,l=c.max,u=!0,d="",f=h({field:s},a.reduce((function(e,n){var a,i,c=null===(i=null==t?void 0:t[n])||void 0===i?void 0:i[s];return!r||"current"!==n||!l||parseFloat(c)<l||(o=!0,u=!1,d="Current benchmark result ".concat(c," > ").concat(l)),h(h({},e),((a={})[n]=c,a))}),{}));return m(m([],b(e),!1),[h(h({},f),{succeed:u,failureDetails:d})],!1)}),[]);return{colorMap:k,columns:m(m([],b(i),!1),b(o?[{name:"succeed",color:"green",alignment:"center",title:"Succeed"},{name:"failureDetails",alignment:"left",title:"Failure details"}]:[]),!1),rows:o?c:c.map((function(e){return e.succeed,e.failureDetails,f(e,["succeed","failureDetails"])})),hasBenchmarkFailed:o}}}(e,h(h(h(h(h({},(null==g?void 0:g.branch)?{branch:g.branch}:{}),(null==g?void 0:g.target)?{target:g.target}:{}),(null==g?void 0:g.initial)?{initial:g.initial}:{}),(null==g?void 0:g.previous)?{previous:g.previous}:{}),a?{current:a}:{})),p=new n.Table(h(h(h({},e.github?j:{rowSeparator:!0}),(E=d,E?h(h({},E),{rows:null==E?void 0:E.rows.map((function(e){var t=e.succeed,r=e.current,n=f(e,["succeed","current"]);return h(h(h({},n),{current:!1===t?l.default.red(r):r}),void 0===t?{}:{succeed:t?l.default.green(O):l.default.red(N)})}))}):E)),{title:"<{ ".concat(r," result }>")})).render(),console.log("\n\n",p.replace(/ /g,"⠀")),t&&(g.previous=a),(null===(A=process.env)||void 0===A?void 0:A.CI)&&e.github){(null==d?void 0:d.hasBenchmarkFailed)&&u.default.setFailed("Action failed, Please check failure details"),y=void 0;try{T=JSON.parse(i.readFileSync(o.resolve(process.cwd(),"package.json"),"utf8")),y=T.name}catch(e){}u.default.summary.addRaw('<h3 align="center"><a href="https://www.npmjs.com/package/'.concat(r,'">').concat(r,"</a></h3>")).addBreak().addTable(function(e){if(!e)return[];var t=e.columns,r=e.rows;return m([t.map((function(e){var t=e.title,r=e.name;return{data:t||r,header:!0}}))],b(r.map((function(e){return Object.values(e).map((function(e){return"boolean"==typeof e?e?S:B:e}))}))),!1)}(d)),y&&u.default.summary.addBreak().addRaw('<small align="right">This test has been created by '.concat(r," for supporting ").concat(y,"</small>")),u.default.summary.addBreak().write()}return[2]}var E}))}))};!function(){p(this,void 0,void 0,(function(){var e,t,n,a,i,o,c;return v(this,(function(s){return e=d.default.scriptName("ts-benchmark").usage("\nUsage:\n $0 -ts path/to/targeted/package/types -p path/to/test/project/that/use/the/target/package").option("path",{alias:"p",describe:"A relative path to project that will be benchmarked.",type:"string",default:"./"}).option("watch",{alias:"w",describe:"A relative path to a directory or a file that trigger benchmark process on any changes.",type:"string"}).option("branch",{alias:"b",describe:"Another git branch name to be benchmarked and compared with the current branch.",type:"string"}).option("save",{alias:"s",describe:"To save and show the previous benchmark result.",type:"boolean",default:!1}).option("initial",{alias:"i",describe:"To save and show the initial benchmark result.",type:"boolean",default:!1}).option("fields",{alias:"f",describe:"To pick and show specific fields of benchmark result by its index numbers.\n Check how this option value format: https://www.npmjs.com/package/ts-benchmark#fields",type:"array"}).option("github",{alias:"g",describe:"To integrate result with github workflow.\n Check how this option value format: https://www.npmjs.com/package/ts-benchmark#fields",type:"boolean"}).option("target",{alias:"t",describe:"Useful for benchmarking targeted branch of github pull request.\n Check how this option value format: https://www.npmjs.com/package/ts-benchmark#fields",type:"boolean"}).wrap(Math.min(100,d.default.terminalWidth())).help().argv,t=e.$0,n=e.save,a=e.watch,i=e.fields,o=e.initial,n&&!a&&console.warn("".concat(t,': "save" option is not available when watch mode is inactive!')),o&&!a&&console.warn("".concat(t,': "initial" option is not available when watch mode is inactive!')),c=function(e){return e&&"string"!=typeof e?null==e?void 0:e.reduce((function(e,t){var r,n=b("number"==typeof t?[t,void 0]:t.split("/").map((function(e){return parseInt(e)})),2),a=n[0],i=n[1],o=a-1;try{return(null==y?void 0:y[o])?h(h({},e),((r={})[o]={label:null==y?void 0:y[o],max:i},r)):e}catch(t){return e}}),{}):y.reduce((function(e,t,r){var n;return h(h({},e),((n={})[r]={label:t},n))}),{})}(i),e.visibleFields=c,function(e){p(void 0,void 0,void 0,(function(){var t,n,a,i,o,c;return v(this,(function(s){switch(s.label){case 0:return t=e.$0,n=e.watch,a=e.branch,i=e.initial,o=e.target,i||a||o?[4,A(e)]:[3,2];case 1:s.sent(),s.label=2;case 2:return n?(c="\n".concat(t,": I am looking for changes... (0_0)\n"),console.log(c),r.watch(n,{persistent:!0}).on("change",(function(){return p(void 0,void 0,void 0,(function(){return v(this,(function(t){switch(t.label){case 0:return[4,I(e)];case 1:return t.sent(),console.log(c),[2]}}))}))}))):I(e),[2]}}))}))}(e),[2]}))}))}();
